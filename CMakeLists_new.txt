cmake_minimum_required(VERSION 3.18)
project(HPCPartitioning LANGUAGES CXX CUDA)

# Intel MPI 우선 탐지, 없으면 일반 MPI 사용
find_package(MPI REQUIRED)
find_package(OpenMP REQUIRED)
find_package(CUDAToolkit REQUIRED)

# MPI 컴파일러 정보 출력
message(STATUS "MPI C compiler: ${MPI_C_COMPILER}")
message(STATUS "MPI CXX compiler: ${MPI_CXX_COMPILER}")
message(STATUS "OpenMP version: ${OpenMP_CXX_VERSION}")

include_directories(${MPI_INCLUDE_PATH})

# CRoaring 라이브러리 설정 (새로 설치한 버전) - 정적 링킹
set(CROARING_PATH "/home/intern_graph/croaring_install")
include_directories(${CROARING_PATH}/include)
set(ROARING_LIBRARY "${CROARING_PATH}/lib/libroaring.a")

# CUDA 및 최적화 설정
set(CMAKE_CUDA_STANDARD 14)
set(CMAKE_CXX_STANDARD 17)

# 기본 빌드 타입을 Release로 설정
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

# 최적화 플래그 설정
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -march=native -mtune=native -DNDEBUG -ffast-math")
set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g -DDEBUG")

# CUDA 최적화 플래그
set(CMAKE_CUDA_FLAGS_RELEASE "-O3 -DNDEBUG")
set(CMAKE_CUDA_FLAGS_DEBUG "-O0 -g -DDEBUG")

message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "CXX flags: ${CMAKE_CXX_FLAGS_${CMAKE_BUILD_TYPE}}")

# OpenMP 최적화 옵션
if(OpenMP_CXX_FOUND)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
endif()

# include 디렉토리
include_directories(${CMAKE_SOURCE_DIR}/include)

# 소스 파일
set(SOURCES
    src/main.cpp
    src/utils.cpp
    src/phase1/phase1.cpp
    src/phase1/init.cpp
    src/phase1/partition.cpp
    src/phase1/seed.cpp
    src/phase2/phase2.cpp
    src/phase2/gpu_lp_boundary.cu
    src/phase2/gpu_memory_optimized.cu
)

add_executable(hpc_partitioning ${SOURCES})

# 컴파일 정의 추가
target_compile_definitions(hpc_partitioning PRIVATE
    GPU_PARTITION
    USE_MASTER_WORKER_PENALTY
    USE_PINNED_MEMORY_OPTIMIZATION
)

# 링킹할 라이브러리들
target_link_libraries(hpc_partitioning 
    ${MPI_CXX_LIBRARIES} 
    OpenMP::OpenMP_CXX 
    ${ROARING_LIBRARY}
    cuda 
    cudart
)

# 정적 링킹 설정
set_target_properties(hpc_partitioning PROPERTIES
    LINK_FLAGS "-static-libgcc -static-libstdc++"
)

# RPATH 설정 (실행 시 라이브러리 경로)
set_target_properties(hpc_partitioning PROPERTIES
    INSTALL_RPATH "/lib/x86_64-linux-gnu;/usr/lib/x86_64-linux-gnu"
    BUILD_WITH_INSTALL_RPATH TRUE
)

# GPU 아키텍처 (원하는 경우 수정)
set_target_properties(hpc_partitioning PROPERTIES
    CUDA_ARCHITECTURES "60;70;75;80"
)

# MPI 실행 시 빌드 후 사용법 출력
message(STATUS "Build complete. Run with:")
message(STATUS "mpirun -np <servers> ./hpc_partitioning <graph_file> <num_partitions>")
